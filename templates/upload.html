{% extends "base.html" %}

{% block title %}Upload Provider Data{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Data Source Selector with Tabs -->
    <div class="source-selector-card">
        <h2>Select Data Source</h2>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('local')">
                üìÅ Upload File / Previous Files
            </button>
            <button class="tab-btn" onclick="switchTab('databricks')" 
                    {% if not databricks_enabled %}disabled title="Databricks not configured"{% endif %}>
                üìä Databricks Tables
            </button>
        </div>
        
        <!-- Local Files Tab -->
        <div id="local-tab" class="tab-content active">
            <!-- Previously Processed Files Dropdown -->
            {% if upload_history %}
            <div class="previous-batch-selector">
                <label for="batchSelector" class="batch-label">
                    <span class="batch-icon">üìÇ</span>
                    View Previously Processed Batch:
                </label>
                <div class="batch-dropdown-container">
                    <select id="batchSelector" class="batch-dropdown" onchange="loadSelectedBatch()">
                        <option value="">-- Select a processed file --</option>
                        {% for file in upload_history %}
                        <option value="{{ file.file_id }}" 
                                data-filename="{{ file.filename }}"
                                data-rows="{{ file.total_rows }}"
                                data-timestamp="{{ file.uploaded_at }}">
                            {{ file.filename }} ({{ file.total_rows }} providers)
                        </option>
                        {% endfor %}
                    </select>
                    <button class="batch-go-btn" onclick="loadSelectedBatch()">View Dashboard</button>
                </div>
            </div>
            <div class="divider-section">
                <span class="divider-text">OR UPLOAD NEW FILE</span>
            </div>
            {% endif %}
    
    <div class="upload-card">
        <h1>Provider Verification Dashboard</h1>
        <p class="subtitle">Upload pre-processed provider verification data</p>
        
        <!-- Upload Zone -->
        <div id="dropZone" class="drop-zone">
            <div class="upload-icon">üìÅ</div>
            <p class="drop-text">Drag and drop your verification results file here</p>
            <p class="drop-subtext">or</p>
            <button class="browse-btn" onclick="document.getElementById('fileInput').click()">
                Browse Files
            </button>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json" style="display: none;">
            <p class="file-info">Supported formats: CSV, Excel (.xlsx, .xls), JSON ‚Ä¢ Max size: 50MB</p>
        </div>
        
        <!-- File Preview (shown after selection) -->
        <div id="filePreview" class="file-preview" style="display: none;">
            <h3>File Preview</h3>
            <div id="previewContent"></div>
            <div id="previewTable"></div>
            <button id="processBtn" class="process-btn">Process File</button>
            <button id="cancelBtn" class="cancel-btn" onclick="resetUpload()">Cancel</button>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing your file...</p>
            <p class="loading-subtext">This may take a moment for large files</p>
        </div>
    </div>
        </div>
        
        <!-- Databricks Tables Tab -->
        <div id="databricks-tab" class="tab-content">
            {% if databricks_enabled %}
            <div class="databricks-selector">
                <label for="tableSelector" class="batch-label">
                    <span class="batch-icon">üìä</span>
                    Select a Databricks Table:
                </label>
                <div class="batch-dropdown-container">
                    <select id="tableSelector" class="batch-dropdown">
                        <option value="">-- Select a Databricks table --</option>
                        {% for table in databricks_tables %}
                        <option value="{{ table.full_name }}" 
                                data-catalog="{{ table.catalog }}"
                                data-schema="{{ table.schema }}"
                                data-rows="{{ table.row_count if table.row_count else 'Unknown' }}">
                            {{ table.full_name }}{% if table.row_count %} ({{ table.row_count }} rows){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button class="batch-go-btn" onclick="loadDatabricksTable()">Load from Databricks</button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="databricksLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading data from Databricks...</p>
                    <p class="loading-subtext">This may take a moment for large tables</p>
                </div>
            </div>
            {% else %}
            <div class="config-message">
                <p>‚ö†Ô∏è Databricks integration not configured</p>
                <p>To enable Databricks table loading:</p>
                <ol style="text-align: left; display: inline-block; margin-top: 12px;">
                    <li>Set <code>ENABLE_DATABRICKS=true</code> in .env</li>
                    <li>Configure Databricks connection details</li>
                    <li>Restart the Flask application</li>
                </ol>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="instructions-card">
        <h3>üìã Expected File Format</h3>
        <p>Your CSV/Excel file should contain pre-processed verification data with these columns:</p>
        <ul>
            <li><strong>Provider Name</strong> (required) - Full name of the healthcare provider</li>
            <li><strong>NPI</strong> (required) - National Provider Identifier (10 digits)</li>
            <li><strong>Address</strong> - Verified street address</li>
            <li><strong>City</strong> - City name</li>
            <li><strong>State</strong> - State abbreviation (e.g., MA, NY)</li>
            <li><strong>ZIP Code</strong> - 5-digit ZIP code</li>
            <li><strong>Specialty</strong> - Medical specialty</li>
            <li><strong>Phone</strong> - Contact phone number</li>
            <li><strong>Email</strong> - Email address</li>
            <li><strong>Confidence Score</strong> - Verification confidence (0-100% or 0-1)</li>
            <li><strong>Status</strong> - Verification status (verified/needs_review/failed)</li>
            <li><strong>Sources</strong> - Data sources consulted (comma-separated)</li>
            <li><strong>Discrepancies</strong> (optional) - Any issues found</li>
        </ul>
        <p class="instructions-note">
            <strong>Note:</strong> The data should already be processed by your backend verification tool. 
            This dashboard is for visualization and analysis only.
        </p>
        <a href="{{ url_for('static', filename='sample_verification_results.csv') }}" class="template-link" download>
            üì• Download Sample File
        </a>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
}

// Load from Databricks table
function loadDatabricksTable() {
    const selector = document.getElementById('tableSelector');
    const tableName = selector.value;
    
    if (!tableName) {
        alert('Please select a Databricks table');
        return;
    }
    
    // Show loading
    document.getElementById('databricksLoading').style.display = 'block';
    
    // Call backend to load table
    fetch('/load-databricks-table', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            table_name: tableName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to dashboard
            window.location.href = `/dashboard?file_id=${data.file_id}`;
        } else {
            alert('Error loading table: ' + (data.error || 'Unknown error'));
            document.getElementById('databricksLoading').style.display = 'none';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        document.getElementById('databricksLoading').style.display = 'none';
    });
}

// Format timestamps in local time
document.addEventListener('DOMContentLoaded', function() {
    const batchSelector = document.getElementById('batchSelector');
    if (batchSelector) {
        const options = batchSelector.querySelectorAll('option[data-timestamp]');
        options.forEach(option => {
            const timestamp = option.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                const localDateTime = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                const filename = option.getAttribute('data-filename');
                const rows = option.getAttribute('data-rows');
                option.textContent = `${filename} (${rows} providers, ${localDateTime})`;
            }
        });
    }
});

// Drag and drop functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
let selectedFile = null;

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // Validate file type
    const validTypes = ['text/csv', 'application/vnd.ms-excel', 
                       'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                       'application/json'];
    const fileName = file.name.toLowerCase();
    const isValidType = validTypes.includes(file.type) || 
                       fileName.endsWith('.csv') || 
                       fileName.endsWith('.xlsx') || 
                       fileName.endsWith('.xls') ||
                       fileName.endsWith('.json');
    
    if (!isValidType) {
        alert('‚ùå Invalid file type. Please upload a CSV, Excel, or JSON file.');
        return;
    }
    
    // Validate file size (50MB limit)
    const maxSize = 50 * 1024 * 1024; // 50MB in bytes
    if (file.size > maxSize) {
        alert('‚ùå File too large. Maximum size is 50MB.');
        return;
    }
    
    selectedFile = file;
    
    // Show preview
    document.getElementById('dropZone').style.display = 'none';
    document.getElementById('filePreview').style.display = 'block';
    
    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
    document.getElementById('previewContent').innerHTML = `
        <div class="file-details">
            <p><strong>üìÑ File:</strong> ${file.name}</p>
            <p><strong>üìä Size:</strong> ${sizeMB} MB</p>
            <p><strong>üìÅ Type:</strong> ${file.name.split('.').pop().toUpperCase()}</p>
        </div>
    `;
    
    // Preview first rows (if possible with FileReader)
    if (fileName.endsWith('.csv')) {
        previewCSV(file);
    } else {
        document.getElementById('previewTable').innerHTML = 
            '<p class="preview-note">Click "Process File" to upload and verify providers.</p>';
    }
    
    // Process button click
    document.getElementById('processBtn').onclick = () => processFile(file);
}

function previewCSV(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').slice(0, 6); // Header + 5 rows
        
        if (lines.length > 1) {
            let tableHTML = '<div class="preview-table-container"><table class="preview-table">';
            
            lines.forEach((line, index) => {
                const cells = line.split(',').map(cell => cell.trim());
                const tag = index === 0 ? 'th' : 'td';
                tableHTML += '<tr>';
                cells.forEach(cell => {
                    tableHTML += `<${tag}>${cell || '-'}</${tag}>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</table></div>';
            tableHTML += '<p class="preview-note">Showing first 5 rows...</p>';
            
            document.getElementById('previewTable').innerHTML = tableHTML;
        }
    };
    reader.readAsText(file);
}

function resetUpload() {
    selectedFile = null;
    document.getElementById('dropZone').style.display = 'block';
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('fileInput').value = '';
}

function processFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('loadingIndicator').style.display = 'block';
    
    // Upload file
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message briefly
            console.log('Upload successful:', data);
            
            // Redirect to dashboard with file_id as query parameter
            window.location.href = `/dashboard?file_id=${data.file_id}`;
        } else {
            // Show error
            alert('‚ùå Error: ' + data.error);
            resetUpload();
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('‚ùå Upload failed: ' + error.message);
        resetUpload();
    });
}

// Load dashboard from dropdown selection
function loadSelectedBatch() {
    const selector = document.getElementById('batchSelector');
    const fileId = selector.value;
    if (fileId) {
        window.location.href = `/dashboard?file_id=${fileId}`;
    }
}
</script>
{% endblock %}
